# MPurse Merchant API 接口规范文档

## 1. 文档概述

### 1.1 文档目的
本文档旨在规范化描述 MPurse Merchant 系统的 API 接口，为前后端开发人员提供清晰的接口规范参考。

### 1.2 适用范围
适用于 MPurse Merchant 系统的前端开发、后端开发、测试和维护人员。

### 1.3 系统架构概述
MPurse Merchant 系统采用前后端分离架构，前端基于 Vue 3 + TypeScript 开发，后端提供 RESTful API 接口。系统包含认证、商户管理、资产管理、KYC 认证等功能模块。

## 2. 接口通用规范

### 2.1 基础 URL
```
/pamapi/
```

### 2.2 请求方法
- GET：获取资源
- POST：创建资源
- PUT：更新资源
- DELETE：删除资源

### 2.3 请求参数
- GET 请求：参数通过 URL 查询字符串传递
- POST/PUT 请求：参数通过请求体 JSON 格式传递

### 2.4 认证方式
系统采用 Bearer Token 认证方式，在请求头中添加：
```
Authorization: Bearer {access_token}
TempToken: {temp_token}
```

### 2.5 数据加密
系统支持请求和响应数据加密，通过环境变量 `VITE_NEED_ENCRYPT` 控制是否启用加密。

### 2.6 响应格式
```json
{
  "code": 0,         // 0 表示成功，非 0 表示失败
  "data": {},       // 响应数据
  "errmsg": ""     // 错误信息
}
```

### 2.7 错误处理
系统定义了多种错误状态码及对应的处理方式：
- 400：请求参数错误
- 401：未授权
- 403：禁止访问
- 404：资源不存在
- 408：请求超时
- 412：需要验证（PIN、OTP 等）
- 429：请求过多
- 500：服务器内部错误

## 3. 接口详细说明

### 3.1 认证相关接口

#### 3.1.1 登录
- 请求路径：`/pamapi/login`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "username": "string",
    "password": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "access_token": "string",
      "refresh_token": "string"
    }
  }
  ```

#### 3.1.2 登出
- 请求路径：`/pamapi/logout`
- 请求方法：GET
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.1.3 刷新令牌
- 请求路径：`/pamapi/refreshtoken`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "refresh_token": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "access_token": "string",
      "refresh_token": "string"
    }
  }
  ```

#### 3.1.4 获取用户信息
- 请求路径：`/pamapi/userinfo`
- 请求方法：GET
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "id": "string",
      "username": "string",
      "email": "string",
      "roles": ["string"]
    }
  }
  ```

#### 3.1.5 重置密码
- 请求路径：`/pamapi/password/reset`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "email": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.1.6 设置 PIN
- 请求路径：`/pamapi/setpin`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "pin": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.1.7 发送 OTP
- 请求路径：`/pamapi/sendotp`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "type": "string",  // 可选值：email, sms
    "recipient": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

### 3.2 商户管理接口

#### 3.2.1 获取商户列表
- 请求路径：`/pamapi/merchant`
- 请求方法：GET
- 请求参数：
  ```
  limit: number  // 每页数量
  page: number   // 页码
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "items": [
        {
          "id": "string",
          "name": "string",
          "status": "string"
        }
      ],
      "total": "number"
    }
  }
  ```

#### 3.2.2 创建商户
- 请求路径：`/pamapi/merchant`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "name": "string",
    "email": "string",
    "phone": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "id": "string"
    }
  }
  ```

#### 3.2.3 更新商户
- 请求路径：`/pamapi/merchant/{id}`
- 请求方法：PUT
- 请求参数：
  ```json
  {
    "name": "string",
    "email": "string",
    "phone": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.2.4 删除商户
- 请求路径：`/pamapi/merchant/{id}`
- 请求方法：DELETE
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.2.5 获取商户详情
- 请求路径：`/pamapi/merchant/{id}`
- 请求方法：GET
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "id": "string",
      "name": "string",
      "email": "string",
      "phone": "string",
      "status": "string"
    }
  }
  ```

### 3.3 商户网关证书接口

#### 3.3.1 获取商户网关证书
- 请求路径：`/pamapi/mpursemc/merchantgatewaycertificate`
- 请求方法：GET
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "id": "string",
      "secret": "string",
      "status": "string"
    }
  }
  ```

#### 3.3.2 更新商户网关证书
- 请求路径：`/pamapi/mpursemc/merchantgatewaycertificate`
- 请求方法：PUT
- 请求参数：
  ```json
  {
    "secret": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.3.3 刷新商户网关证书
- 请求路径：`/pamapi/mpursemc/merchantgatewaycertificate/refresh-secret`
- 请求方法：POST
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "secret": "string"
    }
  }
  ```

#### 3.3.4 激活商户网关证书
- 请求路径：`/pamapi/mpursemc/merchantgatewaycertificate/active`
- 请求方法：POST
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.3.5 下载公钥
- 请求路径：`/pamapi/mpursemc/merchantgatewaycertificate/download-public-key`
- 请求方法：POST
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "public_key": "string"
    }
  }
  ```

#### 3.3.6 上传公钥
- 请求路径：`/pamapi/mpursemc/merchantgatewaycertificate/upload-public-key`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "public_key": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

### 3.4 资产管理接口

#### 3.4.1 获取商户资产
- 请求路径：`/pamapi/mpursemc/merchantasset`
- 请求方法：GET
- 请求参数：
  ```
  currency: string  // 可选，币种
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "items": [
        {
          "currency": "string",
          "balance": "number"
        }
      ]
    }
  }
  ```

#### 3.4.2 获取资产变更记录
- 请求路径：`/pamapi/mpursemc/assetchangerecord`
- 请求方法：GET
- 请求参数：
  ```
  limit: number       // 每页数量
  page: number        // 页码
  currency: string    // 可选，币种
  start_time: string  // 可选，开始时间
  end_time: string    // 可选，结束时间
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "items": [
        {
          "id": "string",
          "currency": "string",
          "amount": "number",
          "type": "string",
          "created_at": "string"
        }
      ],
      "total": "number"
    }
  }
  ```

#### 3.4.3 导出资产变更记录
- 请求路径：`/pamapi/actions/mpursemc/assetchangerecord/export/settlement`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "currency": "string",
    "start_time": "string",
    "end_time": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "file_url": "string"
    }
  }
  ```

### 3.5 提现接口

#### 3.5.1 获取收款人信息
- 请求路径：`/pamapi/withdrawal/payeebene`
- 请求方法：GET
- 请求参数：
  ```
  currency: string  // 可选，币种
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "items": [
        {
          "id": "string",
          "name": "string",
          "account": "string",
          "currency": "string"
        }
      ]
    }
  }
  ```

#### 3.5.2 创建提现
- 请求路径：`/pamapi/withdrawal`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "payee_id": "string",
    "amount": "number",
    "currency": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "id": "string"
    }
  }
  ```

### 3.6 退款接口

#### 3.6.1 检查支付订单
- 请求路径：`/pamapi/actions/mpursemc/payinrefundorder/payinorder`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "order_id": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "order_id": "string",
      "amount": "number",
      "currency": "string",
      "status": "string"
    }
  }
  ```

#### 3.6.2 创建退款
- 请求路径：`/pamapi/actions/mpursemc/payinrefundorder/payinrefund`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "order_id": "string",
    "amount": "number",
    "reason": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "refund_id": "string"
    }
  }
  ```

### 3.7 KYC 认证接口

#### 3.7.1 获取 KYC 详情
- 请求路径：`/pamapi/mckyc`
- 请求方法：GET
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "status": "string",
      "contact": {},
      "business": {},
      "bankaccount": {},
      "proof": {}
    }
  }
  ```

#### 3.7.2 提交联系人信息
- 请求路径：`/pamapi/mckyc/contact`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "name": "string",
    "email": "string",
    "phone": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.7.3 提交银行账户信息
- 请求路径：`/pamapi/mckyc/bankaccount`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "bank_name": "string",
    "account_number": "string",
    "account_name": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.7.4 提交业务信息
- 请求路径：`/pamapi/mckyc/business`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "business_name": "string",
    "business_type": "string",
    "registration_number": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.7.5 提交证明文件
- 请求路径：`/pamapi/mckyc/proof`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "files": ["string"]
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

### 3.8 配置管理接口

#### 3.8.1 获取配置列表
- 请求路径：`/pamapi/configs`
- 请求方法：GET
- 请求参数：
  ```
  limit: number  // 每页数量
  page: number   // 页码
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "items": [
        {
          "id": "string",
          "key": "string",
          "value": "string"
        }
      ],
      "total": "number"
    }
  }
  ```

#### 3.8.2 创建配置
- 请求路径：`/pamapi/configs`
- 请求方法：POST
- 请求参数：
  ```json
  {
    "key": "string",
    "value": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "id": "string"
    }
  }
  ```

#### 3.8.3 更新配置
- 请求路径：`/pamapi/configs/{id}`
- 请求方法：PUT
- 请求参数：
  ```json
  {
    "key": "string",
    "value": "string"
  }
  ```
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.8.4 删除配置
- 请求路径：`/pamapi/configs/{id}`
- 请求方法：DELETE
- 响应参数：
  ```json
  {
    "code": 0
  }
  ```

#### 3.8.5 获取配置详情
- 请求路径：`/pamapi/configs/{id}`
- 请求方法：GET
- 响应参数：
  ```json
  {
    "code": 0,
    "data": {
      "id": "string",
      "key": "string",
      "value": "string"
    }
  }
  ```

## 4. 安全机制

### 4.1 请求节流
系统实现了请求节流机制，限制在特定时间窗口内的请求次数，防止过多请求导致系统负载过高。

### 4.2 重复请求取消
系统会自动取消重复的请求，避免因用户多次点击导致的重复操作。

### 4.3 多因素认证
系统支持多种认证方式：
- PIN 验证
- OTP 验证（短信/邮件）
- PIN + OTP 组合验证

### 4.4 数据加密
系统支持请求和响应数据的加密处理，保障数据传输安全。

## 5. 错误码说明

| 错误码 | 说明 |
| ----- | ---- |
| 0 | 成功 |
| 1001 | 参数错误 |
| 1002 | 未授权 |
| 1003 | 禁止访问 |
| 1004 | 资源不存在 |
| 1005 | 请求超时 |
| 1006 | 需要验证 |
| 1007 | 请求过多 |
| 1008 | 服务器内部错误 |

## 6. 附录

### 6.1 状态码说明

| 状态码 | 说明 |
| ----- | ---- |
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 408 | 请求超时 |
| 412 | 需要验证 |
| 429 | 请求过多 |
| 500 | 服务器内部错误 |

### 6.2 常见问题

1. **Token 过期如何处理？**
   系统会自动尝试使用 refresh_token 刷新 access_token，如果 refresh_token 也过期，则需要重新登录。

2. **如何处理需要验证的请求？**
   当收到 412 状态码时，根据返回的 auth_type 字段，显示对应的验证弹窗（PIN、OTP 或 PIN+OTP），用户完成验证后，系统会自动重试原请求。

3. **如何处理请求过多的情况？**
   当收到 429 状态码时，应当延迟一段时间后再次尝试请求。